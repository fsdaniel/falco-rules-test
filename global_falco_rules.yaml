#file: noinspection YAMLSchemaValidation
- required_engine_version: 15

- required_plugin_versions:
  - name: k8saudit
    version: 0.5.0
    alternatives:
      - name: k8saudit-eks
        version: 0.2.0
  - name: json
    version: 0.7.0

# Like always_true/always_false, but works with k8s audit events
- macro: k8s_audit_always_true
  condition: (jevt.rawtime exists)

- macro: k8s_audit_never_true
  condition: (jevt.rawtime=0)

# Generally only consider audit events once the response has completed
- list: k8s_audit_stages
  items: ["ResponseComplete"]
# This macro selects the set of Audit Events used by the below rules.
- macro: kevt
  condition: (jevt.value[/stage] in (k8s_audit_stages))
- macro: kcreate
  condition: ka.verb=create
- macro: kevt_started
  condition: (jevt.value[/stage]=ResponseStarted)

- macro: allowed_k8s_containers
  condition: (k8s_audit_always_true)

- macro: response_successful
  condition: (ka.response.code startswith 2)


- macro: pod
  condition: ka.target.resource=pods and not ka.target.subresource exists

- macro: pod_subresource
  condition: ka.target.resource=pods and ka.target.subresource exists

- list: user_known_exec_pod_entrypoint_true
  items: [tridentctl]

- macro: user_known_exec_pod_activities_true
  condition: ka.uri.param[command] in (user_known_exec_pod_entrypoint_true)

- rule: Attach/Exec Pod (True)
  desc: >
    Detect any attempt to attach/exec to a pod
  condition: kevt_started and pod_subresource and kcreate and ka.target.subresource in (exec,attach) and not user_known_exec_pod_activities_true
  output: Attach/Exec to pod (user=%ka.user.name pod=%ka.target.name resource=%ka.target.resource ns=%ka.target.namespace action=%ka.target.subresource command=%ka.uri.param[command])
  priority: NOTICE
  source: k8s_audit
  tags: [k8s]

